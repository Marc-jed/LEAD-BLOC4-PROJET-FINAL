pipeline {
    agent any

    environment {
        TEST_DIR = "tests"

        DB_HOST = credentials('DB_HOST')
        DB_NAME = credentials('DB_NAME')
        DB_USER = credentials('DB_USER')
        DB_PASS = credentials('DB_PASS')
        DB_PORT = credentials('DB_PORT')

        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEYy')
        AWS_DEFAULT_REGION = 'eu-west-1'
        S3_BUCKET_NAME = credentials('S3_BUCKET_NAME')
        S3_PREDICTION_DATA_KEY = "compile/dataset_pour_prediction_2025.csv"
        S3_COORD_DATA_KEY = "data_folder/coord_stations.csv"
        S3_FEU_DATA_KEY ="data_folder/historique_incendie_corse_cleaned_2025.csv"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker image') {
            steps {
                sh '''
                    docker build -t fire-tests -f Dockerfile .
                '''
            }
        }

        stage('Run pytest') {
            steps {
                sh '''
                    # Crée un dossier pour les rapports sur l'hôte
                    mkdir -p pytest-reports
                    # Lance le conteneur en montant un volume pour récupérer le rapport
                    docker run --rm \
                        -v $(pwd)/pytest-reports:/app/pytest-reports \
                        fire-tests sh -c "pytest tests/ --junitxml=/app/pytest-reports/pytest-report.xml"
                '''
            }
        }

        stage('Publish test results') {
            steps {
                junit 'pytest-reports/pytest-report.xml'
            }
        }
    }
}
