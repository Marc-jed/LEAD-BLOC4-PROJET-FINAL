pipeline {
    agent any

    environment {
        AWS_DEFAULT_REGION = 'eu-west-1'
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker sanity check') {
            steps {
                sh '''
                    echo "=== Docker version ==="
                    docker --version

                    echo "=== Docker running containers ==="
                    docker ps
                '''
            }
        }

        stage('Build Docker image') {
            steps {
                sh '''
                    docker build -t fire-tests .
                '''
            }
        }

        stage('Run tests') {
            steps {
                withCredentials([
                    string(credentialsId: 'AWS_ACCESS_KEY_ID', variable: 'AWS_ACCESS_KEY_ID'),
                    string(credentialsId: 'AWS_SECRET_ACCESS_KEY', variable: 'AWS_SECRET_ACCESS_KEY'),
                    string(credentialsId: 'S3_BUCKET_NAME', variable: 'S3_BUCKET_NAME')
                ]) {
                    sh '''
                        echo "=== Nettoyage √©ventuel ==="
                        docker rm -f fire-tests-container || true

                        echo "=== Lancement des tests pytest ==="
                        docker run --name fire-tests-container \
                          -e CI=true \
                          -e AWS_ACCESS_KEY_ID \
                          -e AWS_SECRET_ACCESS_KEY \
                          -e AWS_DEFAULT_REGION \
                          -e S3_BUCKET_NAME \
                          fire-tests \
                          pytest tests/ --junitxml=/app/pytest-report.xml
                    '''
                }

                sh '''
                    echo "=== R√©cup√©ration du rapport pytest ==="
                    mkdir -p pytest-reports

                    docker cp fire-tests-container:/app/pytest-report.xml pytest-reports/pytest-report.xml

                    echo "=== Contenu du dossier pytest-reports ==="
                    ls -l pytest-reports

                    echo "=== Nettoyage conteneur de tests ==="
                    docker rm fire-tests-container
                '''

                echo "=== Publication des r√©sultats JUnit ==="
                junit testResults: 'pytest-reports/pytest-report.xml'
            }
        }
    }

    post {
        success {
            echo '‚úÖ Pipeline CI termin√© avec succ√®s'
        }
        failure {
            echo '‚ùå √âchec du pipeline CI'
        }
        always {
            echo 'üèÅ Fin du pipeline'
        }
    }
}
