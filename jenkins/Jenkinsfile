pipeline {
    agent any

    environment {
        TEST_DIR = "tests"
        AWS_DEFAULT_REGION = 'eu-west-1'
        S3_PREDICTION_DATA_KEY = "compile/dataset_pour_prediction_2025.csv"
        S3_COORD_DATA_KEY = "data_folder/coord_stations.csv"
        S3_FEU_DATA_KEY = "data_folder/historique_incendie_corse_cleaned_2025.csv"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker image') {
            steps {
                sh '''
                    docker build -t fire-tests -f Dockerfile .
                '''
            }
        }

        stage('Run pytest') {
            steps {
                script {
                    // Utilise withCredentials pour injecter les secrets de manière sécurisée
                    withCredentials([
                        string(credentialsId: 'DB_HOST', variable: 'DB_HOST'),
                        string(credentialsId: 'DB_NAME', variable: 'DB_NAME'),
                        string(credentialsId: 'DB_USER', variable: 'DB_USER'),
                        string(credentialsId: 'DB_PASS', variable: 'DB_PASS'),
                        string(credentialsId: 'DB_PORT', variable: 'DB_PORT'),
                        string(credentialsId: 'AWS_ACCESS_KEY_ID', variable: 'AWS_ACCESS_KEY_ID'),
                        string(credentialsId: 'AWS_SECRET_ACCESS_KEY', variable: 'AWS_SECRET_ACCESS_KEY'),
                        string(credentialsId: 'S3_BUCKET_NAME', variable: 'S3_BUCKET_NAME')
                    ]) {
                        sh '''
                            # Crée un dossier pour les rapports sur l'hôte
                            mkdir -p pytest-reports
                            # Lance le conteneur en passant les variables d'environnement
                            docker run --rm \
                                -v $(pwd)/pytest-reports:/app/pytest-reports \
                                -e DB_HOST="$DB_HOST" \
                                -e DB_NAME="$DB_NAME" \
                                -e DB_USER="$DB_USER" \
                                -e DB_PASS="$DB_PASS" \
                                -e DB_PORT="$DB_PORT" \
                                -e AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID" \
                                -e AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY" \
                                -e AWS_DEFAULT_REGION="$AWS_DEFAULT_REGION" \
                                -e S3_BUCKET_NAME="$S3_BUCKET_NAME" \
                                -e S3_PREDICTION_DATA_KEY="$S3_PREDICTION_DATA_KEY" \
                                -e S3_COORD_DATA_KEY="$S3_COORD_DATA_KEY" \
                                -e S3_FEU_DATA_KEY="$S3_FEU_DATA_KEY" \
                                fire-tests sh -c "pytest tests/ --junitxml=/app/pytest-reports/pytest-report.xml"
                        '''
                    }
                }
            }
        }

        stage('Publish test results') {
            steps {
                junit 'pytest-reports/pytest-report.xml'
            }
        }
    }
}
